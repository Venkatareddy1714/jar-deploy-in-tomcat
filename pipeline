pipeline {
    agent any

    environment {
        TOMCAT_SERVER = "13.233.81.130"
        TOMCAT_PORT = "9000"
        TOMCAT_USER = "ubuntu"
        TOMCAT_DIR = "/opt/tomcat/webapps"
        JAR_FILE_NAME = "helloworld.jar"
        GITHUB_REPO = "Venkatareddy1714/helloworld"
        GITHUB_BRANCH = "master"
    }

    stages {
        stage('Clone GitHub Repository') {
            steps {
                script {
                    echo "Cloning the GitHub repository..."
                    sh 'rm -rf helloworld'
                    sh 'git clone --branch ${GITHUB_BRANCH} --single-branch https://github.com/${GITHUB_REPO}.git'
                }
            }
        }

        stage('Fetch JAR from GitHub') {
            steps {
                withCredentials([string(credentialsId: 'GITHUB_TOKEN_ID', variable: 'GITHUB_TOKEN')]) {
                    dir('helloworld') {
                        script {
                            echo "Fetching JAR file from GitHub..."
                            sh '''
                                curl -L -H "Authorization: token ${GITHUB_TOKEN}" \
                                    -o ${JAR_FILE_NAME} \
                                    "https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/${JAR_FILE_NAME}"
                            '''
                        }
                    }
                }
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'SSH_CREDENTIALS_ID', keyFileVariable: 'SSH_KEY')]) {
                    script {
                        echo "Deploying JAR file to Tomcat server..."
                        sh '''
                            mkdir -p /var/lib/jenkins/.ssh
                            echo "Host *" > /var/lib/jenkins/.ssh/config
                            echo "  StrictHostKeyChecking no" >> /var/lib/jenkins/.ssh/config
                            echo "  UserKnownHostsFile=/dev/null" >> /var/lib/jenkins/.ssh/config

                            scp -o StrictHostKeyChecking=no -i ${SSH_KEY} helloworld/${JAR_FILE_NAME} ${TOMCAT_USER}@${TOMCAT_SERVER}:${TOMCAT_DIR}/
                            ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TOMCAT_USER}@${TOMCAT_SERVER} "sudo chown tomcat:tomcat ${TOMCAT_DIR}/${JAR_FILE_NAME}"
                            ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TOMCAT_USER}@${TOMCAT_SERVER} "sudo systemctl restart tomcat"
                        '''
                    }
                }
            }
        }
    }
}
